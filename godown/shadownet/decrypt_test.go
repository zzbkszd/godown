package shadownet

import (
	"encoding/hex"
	"fmt"
	"io/ioutil"
	"net"
	"net/http"
	"net/url"
	"path"
	"testing"
)

var testShadowConfig *ShadowConfig = &ShadowConfig{
	Ip:           "127.0.0.1",
	Port:         12300,
	Password:     "password",
	CryptoMethod: "aes-256-cfb",
}

func localSocketReader() {
	addr, _ := net.ResolveTCPAddr("tcp4", "127.0.0.1:12300")
	listener, err := net.ListenTCP("tcp4", addr)
	if err != nil {
		panic(err)
	}
	sock, err := listener.Accept()
	if err != nil {
		panic(err)
	}
	cipher, _ := NewSSCipher(testShadowConfig.CryptoMethod, testShadowConfig.Password)
	for {
		buf := make([]byte, 4096)
		n, _ := sock.Read(buf)
		decode, _ := cipher.decrypt(buf[:n])
		fmt.Println("get content hex:", hex.EncodeToString(decode))
		fmt.Println("get content:", string(decode))
		//respch <- 1
	}
}

func TestSimpleHttpGet(t *testing.T) {
	sock, e := net.Dial("tcp4", "www.owllook.com:80")
	if e != nil {
		panic(e)
	}
	n, e := sock.Write([]byte("Get / HTTP/1.1\r\n\r\nHost: www.owllook.net\r\n\r\n" +
		"User-Agent: Go-http-client/1.1\r\n\r\nAccept-Encoding:gzip\r\n\r\n"))
	if e != nil {
		panic(e)
	}
	buf := make([]byte, 4096)
	n, _ = sock.Read(buf)
	for n > 0 {
		fmt.Println(string(buf[:n]))
		buf = make([]byte, 4096)
		n, _ = sock.Read(buf)
	}

}

func TestProxy(t *testing.T) {
	//go localSocketReader()
	client := GetShadowClient(LocalShadowConfig)
	//client := http.DefaultClient
	u, _ := url.Parse("https://www.baidu.com")
	request := &http.Request{Method: http.MethodGet, URL: u, Header: DefaultHeader}
	resp, err := client.Do(request)
	if err != nil {
		panic(err)
		t.Fail()
	}
	code := resp.Status
	content, _ := ioutil.ReadAll(resp.Body)
	e := ioutil.WriteFile(path.Join("..", "..", "data", "dist.html"), content, 0777)
	if e != nil {
		panic(e)
	}

	fmt.Println("response code:", code, resp.Request.Method)
}

func TestDecrypt(t *testing.T) {
	iv, _ := hex.DecodeString("6015d3817d6c599fec10a77049668df5")
	src, _ := hex.DecodeString("4f474aa256611ba6bb109d0b3ffef796cb64b6a927f98066c20ef26e487c3f78657b54e936f2ef6a840a376c63c3086b21958cacd3d5b4924fb7d2fcafbb23909362807e14358d2eaf7739454418073d26c347fe654c6c377db6a9bff081c8076585a00a4b2cab7c99471a41091daf0f3c436a5f195c972959980c5988abcf885953985be5b2bdb16b945a4922ba8bddd5058bbea8c2d5609fab95ca6e2733f35cc7fe19df95449997eb1e262004dbebeebdb1e418092acbf19f4f3f667f25546f9608cc65143fdd78539158483e9104bc2c35e2d7c244503219aaf54523a74ebf83619d0dd8228e9a4a8cca478e13e0bf096b48e19b58f7a1dba611154b8bfb02bfcb5a8de337c70a5cf80e9a549cbae4b9f16b9cb3626798eb38115236167b1e178b4b81af797ca073ed9435a8ffba29223c399d584a6f43e2e74692fd742898f55998773f60253476913b1421def244e325360266c332c46f79000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000")
	pwd := "password"
	cipher, _ := newAESCFBStream(evpBytesToKey(pwd, cipherMethod["aes-256-cfb"].keyLen), iv, Decrypt)
	dst := make([]byte, len(src))
	cipher.XORKeyStream(dst, src)
	fmt.Println(hex.EncodeToString(dst))
}
